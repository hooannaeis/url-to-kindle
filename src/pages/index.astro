---
import Layout from "../layouts/Layout.astro";
---

<Layout title="URL to Kindle">
  <div
    class="max-w-md mx-auto my-10 overflow-hidden rounded-2xl border border-slate-800 bg-slate-900 shadow-2xl"
  >
    <div class="p-8 bg-gradient-to-b from-slate-800/50 to-transparent">
      <div class="flex flex-col items-center justify-center gap-4 mb-8">
        <div
          class="p-3 rounded-2xl bg-indigo-500/10 border border-indigo-500/20 shadow-inner"
        >
          <img src="/favicon.svg" alt="URL to Kindle Logo" class="h-10 w-10" />
        </div>
        <div class="text-center">
          <h1>URL to Kindle</h1>
          <p class="mt-2 text-sm text-slate-400 italic">
            Your ideal read-later browser-tab cleaner
          </p>
        </div>
      </div>

      <div class="space-y-5">
        <div class="relative group">
          <input
            id="input-field"
            type="text"
            placeholder="https://example.com/article"
            class="w-full bg-slate-950/50 text-slate-200 rounded-xl px-4 py-3.5 border border-slate-700 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all placeholder:text-slate-600 disabled:opacity-50"
          />
        </div>

        <button
          id="submit-button"
          class="group relative w-full overflow-hidden rounded-xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-[1px] font-semibold text-white shadow-[0_0_20px_rgba(99,102,241,0.3)] transition-all hover:shadow-[0_0_30px_rgba(99,102,241,0.5)] active:scale-[0.98] disabled:from-slate-700 disabled:to-slate-800 disabled:cursor-not-allowed"
        >
          <div
            class="flex h-12 w-full items-center justify-center rounded-[11px] bg-slate-900 transition-all group-hover:bg-transparent"
          >
            <span id="submit-text" class="flex items-center gap-2">
              Convert Article
            </span>
          </div>
        </button>

        <button
          id="send-button"
          class="hidden w-full h-12 items-center justify-center gap-2 rounded-xl bg-emerald-500 font-bold text-slate-950 transition-all hover:bg-emerald-400 opacity-0 shadow-[0_0_20px_rgba(16,185,129,0.2)]"
        >
          Send to Kindle
        </button>

        <button
          id="restart-button"
          class="hidden w-full h-12 items-center justify-center rounded-xl bg-slate-800 border border-slate-700 text-slate-300 font-medium transition-all hover:bg-slate-700 opacity-0"
        >
          Start Over
        </button>
      </div>
    </div>

    <div class="bg-slate-950/50 p-8 border-t border-slate-800">
      <h2>How it works</h2>
      <ul class="space-y-3 text-sm text-slate-400">
        <li class="flex gap-3">
          <span
            class="flex-shrink-0 flex items-center justify-center w-5 h-5 rounded-full bg-slate-800 text-xs font-bold text-slate-300"
            >1</span
          >
          <span>Submit the URL of the article</span>
        </li>
        <li class="flex gap-3">
          <span
            class="flex-shrink-0 flex items-center justify-center w-5 h-5 rounded-full bg-slate-800 text-xs font-bold text-slate-300"
            >2</span
          >
          <span>Wait for the optimized Kindle file</span>
        </li>
        <li class="flex gap-3">
          <span
            class="flex-shrink-0 flex items-center justify-center w-5 h-5 rounded-full bg-slate-800 text-xs font-bold text-slate-300"
            >3</span
          >
          <span
            >Share to your <a
              href="https://www.amazon.com/sendtokindle/email"
              target="_blank"
              class="text-indigo-400 hover:text-indigo-300 underline decoration-indigo-400/30 underline-offset-4 transition-colors"
              >Kindle Email</a
            ></span
          >
        </li>
      </ul>
    </div>
  </div>

  <script>
    import { trackEvent } from "../scripts/trackEvent";

    async function handleSubmit() {
      const submitButton = document.getElementById("submit-button");
      const submitText = document.getElementById("submit-text");
      const inputField = document.getElementById("input-field");
      const sendButton = document.getElementById("send-button");

      // Disable submit button and show loading state
      submitButton.disabled = true;
      inputField.disabled = true;
      submitText.innerHTML = '<span class="spinner"></span> Converting...';

      try {
        const url = inputField.value;
        if (!url) {
          showError("Please enter a URL");
          return;
        }
        trackEvent({
          event_name: "submission_started",
          content_url: url,
        });

        // Validate URL format
        if (!isValidUrl(url)) {
          showError("Please enter a valid URL (e.g., https://example.com)");
          return;
        }

        // Make GET request to /convert with url as query parameter
        let conversionPath = "/convert";
        if (document.location.hostname === "localhost") {
          conversionPath =
            "http://127.0.0.1:5001/url-to-kindle/europe-west3/convert";
        }
        const response = await fetch(
          `${conversionPath}?url=${encodeURIComponent(url)}`
        );

        if (!response.ok) {
          throw new Error("Request failed with status: " + response.status);
        }

        // Extract filename from Content-Disposition header
        let filename = "article.epub"; // default filename
        const contentDisposition = response.headers.get("content-disposition");
        if (contentDisposition) {
          const split = contentDisposition.split("filename=");
          if (split && split[1]) {
            filename = split[1];
          }
        }

        // Get the HTML content from the response
        const htmlContent = await response.text();

        // Create a blob with the HTML content
        const blob = new Blob([htmlContent], { type: "text/html" });

        // Create a download link for the HTML file
        const downloadUrl = URL.createObjectURL(blob);

        // Store the download URL and filename for later use in the send button
        sendButton.dataset.downloadUrl = downloadUrl;
        sendButton.dataset.filename = filename;
        trackEvent({
          event_name: "submission_processed",
          content_url: url,
        });
        // Show success message
        showSuccess("Article converted successfully! Ready to send to Kindle.");

        // Smoothly transition to send button
        setTimeout(() => {
          submitButton.style.opacity = "0";
          setTimeout(() => {
            submitButton.classList.add("hidden");
            sendButton.classList.remove("hidden");
            // Force reflow
            void sendButton.offsetWidth;
            sendButton.style.opacity = "1";
          }, 300);
        }, 500);

        return; // Exit early on success
      } catch (error) {
        console.error("Error:", error);
        showError(
          "An error occurred while processing your request: " + error.message
        );
        // Reset button state on error
        submitButton.disabled = false;
        submitText.textContent = "Convert Article";
      }
    }

    async function handleSendToKindle() {
      const sendButton = document.getElementById("send-button");
      const restartButton = document.getElementById("restart-button");

      const downloadUrl = sendButton.dataset.downloadUrl;
      const filename = sendButton.dataset.filename || "article.html";

      if (downloadUrl) {
        try {
          // Fetch the blob from the object URL
          const response = await fetch(downloadUrl);
          const blob = await response.blob();

          // Create a File object from the blob with the correct filename
          const file = new File([blob], filename, { type: "text/html" });

          // Check if Web Share API is available and can share files
          if (
            navigator.share &&
            navigator.canShare &&
            navigator.canShare({ files: [file] })
          ) {
            // Use Web Share API to share the file
            await navigator.share({
              files: [file],
              title: "Article for Kindle",
            });
            trackEvent({
              event_name: "submission_shared",
              content_url: downloadUrl,
              share_type: "navigator_share",
            });
            showSuccess("Share completed!");
          } else {
            // Fallback: Download file and open email client
            const downloadLink = document.createElement("a");
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            downloadLink.click();
            trackEvent({
              event_name: "submission_shared",
              content_url: downloadUrl,
              share_type: "file_download",
            });
          }
        } catch (error) {
          // If user cancels the share or an error occurs, show message
          if (error.name !== "AbortError") {
            console.error("Error sharing:", error);
            showError("Could not share the file. Downloading instead.");

            // Fallback to download
            const downloadLink = document.createElement("a");
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            downloadLink.click();
          }
        } finally {
          // Smoothly transition to restart button
          sendButton.style.opacity = "0";
          setTimeout(() => {
            sendButton.classList.add("hidden");
            restartButton.classList.remove("hidden");
            // Force reflow
            void restartButton.offsetWidth;
            restartButton.style.opacity = "1";
          }, 300);
        }
      } else {
        // Smoothly transition to restart button
        sendButton.style.opacity = "0";
        setTimeout(() => {
          sendButton.classList.add("hidden");
          restartButton.classList.remove("hidden");
          // Force reflow
          void restartButton.offsetWidth;
          restartButton.style.opacity = "1";
        }, 300);
      }
    }

    // Helper function to validate URL
    function isValidUrl(url) {
      try {
        new URL(url);
        return true;
      } catch (e) {
        return false;
      }
    }

    // Helper function to show error messages
    function showError(message) {
      // Create error notification
      const errorNotification = document.createElement("div");
      errorNotification.className =
        "fixed top-4 right-4 bg-red-50 text-red-800 border border-red-200 px-4 py-3 rounded-md shadow-sm z-50";
      errorNotification.textContent = message;
      errorNotification.style.animation = "fadeIn 0.3s ease-out";

      document.body.appendChild(errorNotification);
      trackEvent({
        event_name: "error_shown",
        error_message: message,
      });
      // Remove after 3 seconds
      setTimeout(() => {
        errorNotification.remove();
      }, 3000);
    }

    // Helper function to show success messages
    function showSuccess(message) {
      const successNotification = document.createElement("div");
      successNotification.className =
        "fixed top-4 right-4 bg-green-50 text-green-800 border border-green-200 px-4 py-3 rounded-md shadow-sm z-50";
      successNotification.textContent = message;
      successNotification.style.animation = "fadeIn 0.3s ease-out";

      document.body.appendChild(successNotification);

      // Remove after 3 seconds
      setTimeout(() => {
        successNotification.remove();
      }, 3000);
    }

    function handleRestart() {
      trackEvent({
        event_name: "reload",
      });
      document.location.reload();
    }

    // Add event listener to submit button
    document
      .getElementById("submit-button")
      .addEventListener("click", handleSubmit);

    // Add event listener to submit button
    document
      .getElementById("restart-button")
      .addEventListener("click", handleRestart);

    // Add event listener to send button
    document
      .getElementById("send-button")
      .addEventListener("click", handleSendToKindle);
  </script>
</Layout>
