---
import Layout from "../layouts/Layout.astro";
---

<Layout title="URL to Kindle">
    <div class="bg-slate-50 rounded-lg p-8 shadow-sm border border-slate-200">
      <h1>URL to Kindle</h1>

      <div class="space-y-4">
        <input
          id="input-field"
          type="text"
          placeholder="Enter article URL..."
          class="w-full bg-slate-50 text-slate-800 rounded-md px-4 py-2.5 border border-slate-300 focus:outline-none focus:border-slate-800 focus:ring-1 focus:ring-slate-800 disabled:border-slate-200 disabled:bg-slate-50 disabled:text-slate-500"
        />

        <button
          id="submit-button"
          class="cursor-pointer disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-500 w-full bg-slate-800 hover:bg-slate-800 text-slate-50 font-medium py-2.5 px-4 rounded-md transition-all duration-300 flex items-center justify-center gap-2"
        >
          <span id="submit-text">Convert Article</span>
        </button>

        <button
          id="send-button"
          class="cursor-pointer hidden w-full bg-slate-800 hover:bg-slate-800 text-slate-50 font-medium py-2.5 px-4 rounded-md transition-all duration-300 opacity-0"
        >
          Send to Kindle
        </button>

        <button
          id="restart-button"
          class="cursor-pointer hidden w-full bg-slate-800 hover:bg-slate-800 text-slate-50 font-medium py-2.5 px-4 rounded-md transition-all duration-300 opacity-0"
        >
          Start Over
        </button>
      </div>

      <!-- Instructions -->
      <div class="mt-6 text-center text-sm text-slate-500">
        <p>Enter any article URL to convert it to Kindle format</p>
      </div>
    </div>


  <script>
    import { trackEvent } from "../scripts/trackEvent";

    async function handleSubmit() {
      const submitButton = document.getElementById("submit-button");
      const submitText = document.getElementById("submit-text");
      const inputField = document.getElementById("input-field");
      const sendButton = document.getElementById("send-button");

      // Disable submit button and show loading state
      submitButton.disabled = true;
      inputField.disabled = true;
      submitText.innerHTML = '<span class="spinner"></span> Converting...';

      try {
        const url = inputField.value;
        if (!url) {
          showError("Please enter a URL");
          return;
        }
        trackEvent({
          event_name: "submission_started",
          content_url: url,
        });

        // Validate URL format
        if (!isValidUrl(url)) {
          showError("Please enter a valid URL (e.g., https://example.com)");
          return;
        }

        // Make GET request to /convert with url as query parameter
        const response = await fetch(`/convert?url=${encodeURIComponent(url)}`);

        if (!response.ok) {
          throw new Error("Request failed with status: " + response.status);
        }

        // Extract filename from Content-Disposition header
        let filename = "article.html"; // default filename
        const contentDisposition = response.headers.get("Content-Disposition");
        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(
            /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/
          );
          if (filenameMatch && filenameMatch[1]) {
            filename = filenameMatch[1].replace(/['"]/g, "");
          }
        }

        // Get the HTML content from the response
        const htmlContent = await response.text();

        // Create a blob with the HTML content
        const blob = new Blob([htmlContent], { type: "text/html" });

        // Create a download link for the HTML file
        const downloadUrl = URL.createObjectURL(blob);

        // Store the download URL and filename for later use in the send button
        sendButton.dataset.downloadUrl = downloadUrl;
        sendButton.dataset.filename = filename;
        trackEvent({
          event_name: "submission_processed",
          content_url: url,
        });
        // Show success message
        showSuccess("Article converted successfully! Ready to send to Kindle.");

        // Smoothly transition to send button
        setTimeout(() => {
          submitButton.style.opacity = "0";
          setTimeout(() => {
            submitButton.classList.add("hidden");
            sendButton.classList.remove("hidden");
            // Force reflow
            void sendButton.offsetWidth;
            sendButton.style.opacity = "1";
          }, 300);
        }, 500);

        return; // Exit early on success
      } catch (error) {
        console.error("Error:", error);
        showError(
          "An error occurred while processing your request: " + error.message
        );
        // Reset button state on error
        submitButton.disabled = false;
        submitText.textContent = "Convert Article";
      }
    }

    async function handleSendToKindle() {
      const sendButton = document.getElementById("send-button");
      const restartButton = document.getElementById("restart-button");

      const downloadUrl = sendButton.dataset.downloadUrl;
      const filename = sendButton.dataset.filename || "article.html";

      if (downloadUrl) {
        try {
          // Fetch the blob from the object URL
          const response = await fetch(downloadUrl);
          const blob = await response.blob();

          // Create a File object from the blob with the correct filename
          const file = new File([blob], filename, { type: "text/html" });

          // Check if Web Share API is available and can share files
          if (
            navigator.share &&
            navigator.canShare &&
            navigator.canShare({ files: [file] })
          ) {
            // Use Web Share API to share the file
            await navigator.share({
              files: [file],
              title: "Article for Kindle",
            });
            trackEvent({
              event_name: "submission_shared",
              content_url: downloadUrl,
              share_type: "navigator_share",
            });
            showSuccess("Share completed!");
          } else {
            // Fallback: Download file and open email client
            const downloadLink = document.createElement("a");
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            downloadLink.click();
            trackEvent({
              event_name: "submission_shared",
              content_url: downloadUrl,
              share_type: "file_download",
            });
          }
        } catch (error) {
          // If user cancels the share or an error occurs, show message
          if (error.name !== "AbortError") {
            console.error("Error sharing:", error);
            showError("Could not share the file. Downloading instead.");

            // Fallback to download
            const downloadLink = document.createElement("a");
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            downloadLink.click();
          }
        } finally {
          // Smoothly transition to restart button
          sendButton.style.opacity = "0";
          setTimeout(() => {
            sendButton.classList.add("hidden");
            restartButton.classList.remove("hidden");
            // Force reflow
            void restartButton.offsetWidth;
            restartButton.style.opacity = "1";
          }, 300);
        }
      } else {
        // Smoothly transition to restart button
        sendButton.style.opacity = "0";
        setTimeout(() => {
          sendButton.classList.add("hidden");
          restartButton.classList.remove("hidden");
          // Force reflow
          void restartButton.offsetWidth;
          restartButton.style.opacity = "1";
        }, 300);
      }
    }

    // Helper function to validate URL
    function isValidUrl(url) {
      try {
        new URL(url);
        return true;
      } catch (e) {
        return false;
      }
    }

    // Helper function to show error messages
    function showError(message) {
      // Create error notification
      const errorNotification = document.createElement("div");
      errorNotification.className =
        "fixed top-4 right-4 bg-red-50 text-red-800 border border-red-200 px-4 py-3 rounded-md shadow-sm z-50";
      errorNotification.textContent = message;
      errorNotification.style.animation = "fadeIn 0.3s ease-out";

      document.body.appendChild(errorNotification);
      trackEvent({
        event_name: "error_shown",
        error_message: message,
      });
      // Remove after 3 seconds
      setTimeout(() => {
        errorNotification.remove();
      }, 3000);
    }

    // Helper function to show success messages
    function showSuccess(message) {
      const successNotification = document.createElement("div");
      successNotification.className =
        "fixed top-4 right-4 bg-green-50 text-green-800 border border-green-200 px-4 py-3 rounded-md shadow-sm z-50";
      successNotification.textContent = message;
      successNotification.style.animation = "fadeIn 0.3s ease-out";

      document.body.appendChild(successNotification);

      // Remove after 3 seconds
      setTimeout(() => {
        successNotification.remove();
      }, 3000);
    }

    function handleRestart() {
      trackEvent({
        event_name: "reload",
      });
      document.location.reload();
    }

    // Add event listener to submit button
    document
      .getElementById("submit-button")
      .addEventListener("click", handleSubmit);

    // Add event listener to submit button
    document
      .getElementById("restart-button")
      .addEventListener("click", handleRestart);

    // Add event listener to send button
    document
      .getElementById("send-button")
      .addEventListener("click", handleSendToKindle);
  </script>
</Layout>
